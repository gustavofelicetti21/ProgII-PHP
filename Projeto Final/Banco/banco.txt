PRAGMA foreign_keys = ON;

BEGIN TRANSACTION;

-- =========================
-- TABELAS PRINCIPAIS
-- =========================

CREATE TABLE cliente (
  id_cliente   INTEGER PRIMARY KEY AUTOINCREMENT,
  nome         TEXT        NOT NULL,
  cpf          TEXT        NOT NULL UNIQUE,
  telefone     TEXT,
  email        TEXT        UNIQUE
);

CREATE INDEX idx_cliente_nome    ON cliente (nome);
CREATE INDEX idx_cliente_telefone ON cliente (telefone);

CREATE TABLE restaurante (
  id_restaurante INTEGER PRIMARY KEY AUTOINCREMENT,
  nome           TEXT       NOT NULL,
  cnpj           TEXT       NOT NULL UNIQUE
);

CREATE INDEX idx_restaurante_nome ON restaurante (nome);

-- Endereço pertence exclusivamente a um Cliente OU a um Restaurante
CREATE TABLE endereco (
  id_endereco     INTEGER PRIMARY KEY AUTOINCREMENT,
  cliente_id      INTEGER,
  restaurante_id  INTEGER,
  cep             TEXT    NOT NULL,
  rua             TEXT    NOT NULL,
  numero          INTEGER NOT NULL,
  complemento     TEXT,
  bairro          TEXT    NOT NULL,
  cidade          TEXT    NOT NULL,
  uf              TEXT    NOT NULL,
  CONSTRAINT ck_endereco_dono_exclusivo
    CHECK (
      (cliente_id IS NOT NULL AND restaurante_id IS NULL)
      OR
      (cliente_id IS NULL AND restaurante_id IS NOT NULL)
    ),
  CONSTRAINT fk_endereco_cliente
    FOREIGN KEY (cliente_id)
    REFERENCES cliente(id_cliente)
    ON DELETE CASCADE
    ON UPDATE RESTRICT,
  CONSTRAINT fk_endereco_restaurante
    FOREIGN KEY (restaurante_id)
    REFERENCES restaurante(id_restaurante)
    ON DELETE CASCADE
    ON UPDATE RESTRICT
);

CREATE INDEX idx_endereco_cliente     ON endereco (cliente_id);
CREATE INDEX idx_endereco_restaurante ON endereco (restaurante_id);
CREATE INDEX idx_endereco_cep         ON endereco (cep);

-- Produto é do Restaurante (composição)
CREATE TABLE produto (
  id_produto      INTEGER PRIMARY KEY AUTOINCREMENT,
  nome            TEXT        NOT NULL,
  descricao       TEXT,
  id_restaurante  INTEGER     NOT NULL,
  CONSTRAINT fk_produto_restaurante
    FOREIGN KEY (id_restaurante)
    REFERENCES restaurante(id_restaurante)
    ON DELETE CASCADE
    ON UPDATE RESTRICT
);

CREATE INDEX idx_produto_restaurante ON produto (id_restaurante);
CREATE INDEX idx_produto_nome        ON produto (nome);

-- Ingrediente é próprio do Produto (modelo B - composição)
CREATE TABLE ingrediente_produto (
  id_ingrediente  INTEGER PRIMARY KEY AUTOINCREMENT,
  ingrediente     TEXT        NOT NULL,
  id_produto      INTEGER     NOT NULL,
  CONSTRAINT fk_ingrediente_produto
    FOREIGN KEY (id_produto)
    REFERENCES produto(id_produto)
    ON DELETE CASCADE
    ON UPDATE RESTRICT
);

CREATE INDEX idx_ing_prod_id_produto ON ingrediente_produto (id_produto);

-- Pedido agregado a Restaurante e associado a Cliente (sem cascade)
CREATE TABLE pedido (
  id_pedido       INTEGER PRIMARY KEY AUTOINCREMENT,
  id_restaurante  INTEGER NOT NULL,
  vl_total        INTEGER NOT NULL DEFAULT 0,
  id_cliente      INTEGER NOT NULL,
  CONSTRAINT fk_pedido_restaurante
    FOREIGN KEY (id_restaurante)
    REFERENCES restaurante(id_restaurante)
    ON DELETE RESTRICT
    ON UPDATE RESTRICT,
  CONSTRAINT fk_pedido_cliente
    FOREIGN KEY (id_cliente)
    REFERENCES cliente(id_cliente)
    ON DELETE RESTRICT
    ON UPDATE RESTRICT
);

CREATE INDEX idx_pedido_restaurante ON pedido (id_restaurante);
CREATE INDEX idx_pedido_cliente     ON pedido (id_cliente);

-- ItemPedido é parte do Pedido (composição)
-- e referencia Produto (agregação → RESTRICT)
CREATE TABLE item_pedido (
  id_produto   INTEGER NOT NULL,
  quantidade   INTEGER NOT NULL,
  vl_produto   INTEGER NOT NULL,
  id_pedido    INTEGER NOT NULL,
  CONSTRAINT pk_item_pedido PRIMARY KEY (id_produto, id_pedido),
  CONSTRAINT fk_item_pedido_produto
    FOREIGN KEY (id_produto)
    REFERENCES produto(id_produto)
    ON DELETE RESTRICT
    ON UPDATE RESTRICT,
  CONSTRAINT fk_item_pedido_pedido
    FOREIGN KEY (id_pedido)
    REFERENCES pedido(id_pedido)
    ON DELETE CASCADE
    ON UPDATE RESTRICT
);

CREATE INDEX idx_item_pedido_pedido  ON item_pedido (id_pedido);
CREATE INDEX idx_item_pedido_produto ON item_pedido (id_produto);

COMMIT;
